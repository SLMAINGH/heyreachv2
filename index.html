<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeyReach Conversation Dashboard V2</title>
</head>
<body>
    <!-- Konfiguracja -->
    <div id="config-section">
        <h2>Konfiguracja</h2>
        <div>
            <label>Hasło (X-Custom-Auth): <input type="password" id="auth-password" placeholder="Wprowadź hasło"></label>
        </div>
        
        <h3>Wybierz klucze API:</h3>
        <div id="api-keys">
            <label><input type="checkbox" value="ICP"> ICP</label>
            <label><input type="checkbox" value="account2"> account2</label>
            <label><input type="checkbox" value="account3"> account3</label>
        </div>
        
        <button id="fetch-data-btn">Pobierz Dane</button>
        <div id="loading" style="display:none;">Ładowanie...</div>
        <div id="error-msg" style="color:red;"></div>
    </div>

    <hr>

    <!-- Filtry -->
    <div id="filters-section" style="display:none;">
        <h2>Filtry</h2>
        
        <div>
            <label><input type="checkbox" id="filter-has-response"> Pokaż tylko z odpowiedzią</label>
        </div>
        
        <div>
            <h4>Klucz API:</h4>
            <div id="filter-api-keys"></div>
        </div>
        
        <div>
            <h4>Osoba wysyłająca:</h4>
            <div id="filter-senders"></div>
        </div>
        
        <div>
            <h4>Kampania:</h4>
            <div id="filter-campaigns"></div>
        </div>
        
        <button id="apply-filters-btn">Zastosuj filtry</button>
    </div>

    <hr>

    <!-- Statystyki -->
    <div id="stats-section" style="display:none;">
        <h2>Statystyki</h2>
        <div>Liczba rozpoczętych wątków: <span id="stats-total">0</span></div>
        <div>Liczba konwersacji z odpowiedzią: <span id="stats-with-response">0</span></div>
        <div>Współczynnik odpowiedzi: <span id="stats-response-rate">0%</span></div>
    </div>

    <hr>

    <!-- Lista konwersacji -->
    <div id="conversations-section" style="display:none;">
        <h2>Konwersacje</h2>
        <button id="export-csv-btn">Pobierz jako CSV</button>
        <table id="conversations-table" border="1">
            <thead>
                <tr>
                    <th>Imię i Nazwisko</th>
                    <th>Ostatnia wiadomość</th>
                    <th>Kampania</th>
                    <th>Klucz API</th>
                    <th>Akcja</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Podgląd wątku -->
    <div id="thread-preview" style="display:none;">
        <h3>Szczegóły konwersacji</h3>
        <button id="close-thread">Zamknij</button>
        <div id="thread-content"></div>
    </div>

    <script type="module">
        // Interfejsy TypeScript (w komentarzach dla dokumentacji)
        /*
        interface LinkedInAccount {
            id: number;
            emailAddress: string;
            firstName: string;
            lastName: string;
            isActive: boolean;
            activeCampaigns: number;
            authIsValid: boolean;
            isValidNavigator: boolean;
            isValidRecruiter: boolean;
        }

        interface Campaign {
            id: number;
            name: string;
            creationTime: string;
            linkedInUserListName: string;
            linkedInUserListId: number;
            campaignAccountIds: number[];
            status: string;
            progressStats: {
                totalUsers: number;
                totalUsersInProgress: number;
                totalUsersPending: number;
                totalUsersFinished: number;
                totalUsersFailed: number;
            };
        }

        interface Conversation {
            id: string;
            read: boolean;
            groupChat: boolean;
            blockedByMe: boolean;
            blockedByParticipant: boolean;
            lastMessageAt: string;
            lastMessageText: string;
            lastMessageSender: any;
            totalMessages: number;
            campaignId: number;
            linkedInAccountId: number;
            correspondentProfile: {
                profileUrl: string;
                firstName: string;
                lastName: string;
                headline: string;
                imageUrl: string;
                location: string;
                companyName: string;
                companyUrl: string;
                position: string;
                about: string;
                connections: number;
                followers: number;
                tags: string[];
                emailAddress: string;
                customFields: { name: string; value: string; }[];
            };
            linkedInAccount: LinkedInAccount;
            messages: {
                createdAt: string;
                body: string;
                subject: string;
                postLink: string;
                isInMail: boolean;
                sender: any;
            }[];
            apiKeyAlias?: string; // dodatkowe pole do przechowywania aliasu klucza
            hasResponse?: boolean; // czy ma odpowiedź od rozmówcy
        }
        */

        // Stan aplikacji
        const state = {
            workerUrl: 'https://snowy-hall-5f3d.lammelstanislaw.workers.dev',
            authPassword: '',
            selectedApiKeys: [],
            accounts: [],
            campaigns: [],
            conversations: [],
            filteredConversations: [],
            filters: {
                hasResponse: false,
                apiKeys: [],
                senderIds: [],
                campaignIds: []
            }
        };

        // Pomocnicza funkcja do wywołań API
        async function apiCall(endpoint, method = 'GET', body = null, apiKeyAlias = null) {
            const headers = {
                'X-Custom-Auth': state.authPassword,
                'Content-Type': 'application/json'
            };
            
            if (apiKeyAlias) {
                headers['X-API-KEY'] = apiKeyAlias;
            }

            const options = {
                method,
                headers
            };

            if (body && method === 'POST') {
                options.body = JSON.stringify(body);
            }
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            return response.json();
        }

        // Pobieranie danych
        async function fetchData() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-msg');
            
            loadingEl.style.display = 'block';
            errorEl.textContent = '';

            try {
                // Resetuj stan
                state.accounts = [];
                state.campaigns = [];
                state.conversations = [];

                // Dla każdego wybranego klucza
                for (const apiKey of state.selectedApiKeys) {
                    // Pobierz konta (senders)
                    const accountsData = await apiCall('/api/public/li_account/GetAll', 'POST', { offset: 0, limit: 100 }, apiKey);
                    const accounts = accountsData.items || [];
                    
                    // Dodaj do globalnej listy z informacją o kluczu
                    accounts.forEach(acc => {
                        acc.apiKeyAlias = apiKey;
                        state.accounts.push(acc);
                    });

                    // Pobierz kampanie
                    const campaignsData = await apiCall('/api/public/campaign/GetAll', 'POST', { offset: 0, limit: 100 }, apiKey);
                    const campaigns = campaignsData.items || [];
                    
                    campaigns.forEach(camp => {
                        camp.apiKeyAlias = apiKey;
                        state.campaigns.push(camp);
                    });

                    // Pobierz wszystkie konwersacje (z paginacją)
                    let offset = 0;
                    const limit = 100;
                    let hasMore = true;

                    while (hasMore) {
                        const conversationsData = await apiCall('/api/public/inbox/GetConversations', 'POST', {
                            offset,
                            limit,
                            filters: {}
                        }, apiKey);

                        const conversations = conversationsData.items || [];
                        
                        conversations.forEach(conv => {
                            conv.apiKeyAlias = apiKey;
                            state.conversations.push(conv);
                        });

                        offset += limit;
                        hasMore = conversations.length === limit && offset < conversationsData.totalCount;
                    }
                }

                // Sprawdź odpowiedzi dla każdej konwersacji
                for (const conv of state.conversations) {
                    try {
                        const chatroom = await apiCall(
                            `/api/public/inbox/GetChatroom/${conv.linkedInAccountId}/${conv.id}`, 
                            'GET', 
                            null, 
                            conv.apiKeyAlias
                        );
                        
                        // Sprawdź czy są wiadomości od correspondentProfile
                        conv.hasResponse = chatroom.messages?.some(msg => 
                            msg.sender === 'correspondentProfile'
                        ) || false;
                        
                        // Zapisz pełne dane chatroom
                        conv.fullData = chatroom;
                    } catch (err) {
                        console.error(`Error fetching chatroom for ${conv.id}:`, err);
                        conv.hasResponse = false;
                    }
                }

                // Pokaż filtry i konwersacje
                createFilters();
                showSections();
                applyFilters();

            } catch (error) {
                errorEl.textContent = `Błąd: ${error.message}`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Tworzenie dynamicznych filtrów
        function createFilters() {
            // Filtry kluczy API
            const apiKeysContainer = document.getElementById('filter-api-keys');
            apiKeysContainer.innerHTML = '';
            const uniqueApiKeys = [...new Set(state.conversations.map(c => c.apiKeyAlias))];
            uniqueApiKeys.forEach(key => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${key}" checked> ${key}`;
                apiKeysContainer.appendChild(label);
            });

            // Filtry osób wysyłających
            const sendersContainer = document.getElementById('filter-senders');
            sendersContainer.innerHTML = '';
            const uniqueSenders = [...new Map(state.accounts.map(acc => [acc.id, acc])).values()];
            uniqueSenders.forEach(sender => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${sender.id}" checked> ${sender.firstName} ${sender.lastName}`;
                sendersContainer.appendChild(label);
            });

            // Filtry kampanii
            const campaignsContainer = document.getElementById('filter-campaigns');
            campaignsContainer.innerHTML = '';
            const uniqueCampaigns = [...new Map(state.campaigns.map(camp => [camp.id, camp])).values()];
            uniqueCampaigns.forEach(campaign => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${campaign.id}" checked> ${campaign.name}`;
                campaignsContainer.appendChild(label);
            });
        }

        // Zastosowanie filtrów
        function applyFilters() {
            // Pobierz wartości filtrów
            state.filters.hasResponse = document.getElementById('filter-has-response').checked;
            
            state.filters.apiKeys = [...document.querySelectorAll('#filter-api-keys input:checked')]
                .map(cb => cb.value);
            
            state.filters.senderIds = [...document.querySelectorAll('#filter-senders input:checked')]
                .map(cb => parseInt(cb.value));
            
            state.filters.campaignIds = [...document.querySelectorAll('#filter-campaigns input:checked')]
                .map(cb => parseInt(cb.value));

            // Filtruj konwersacje
            state.filteredConversations = state.conversations.filter(conv => {
                if (state.filters.hasResponse && !conv.hasResponse) return false;
                if (!state.filters.apiKeys.includes(conv.apiKeyAlias)) return false;
                if (!state.filters.senderIds.includes(conv.linkedInAccountId)) return false;
                if (conv.campaignId && !state.filters.campaignIds.includes(conv.campaignId)) return false;
                
                return true;
            });

            // Aktualizuj widok
            updateConversationsTable();
            updateStats();
        }

        // Aktualizacja tabeli konwersacji
        function updateConversationsTable() {
            const tbody = document.querySelector('#conversations-table tbody');
            tbody.innerHTML = '';

            state.filteredConversations.forEach(conv => {
                const campaign = state.campaigns.find(c => c.id === conv.campaignId);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${conv.correspondentProfile?.firstName || ''} ${conv.correspondentProfile?.lastName || ''}</td>
                    <td>${conv.lastMessageText || 'Brak wiadomości'}</td>
                    <td>${campaign?.name || 'Brak kampanii'}</td>
                    <td>${conv.apiKeyAlias}</td>
                    <td><button onclick="window.openThread('${conv.id}', '${conv.apiKeyAlias}', ${conv.linkedInAccountId})">Otwórz wątek</button></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Aktualizacja statystyk
        function updateStats() {
            const total = state.filteredConversations.length;
            const withResponse = state.filteredConversations.filter(c => c.hasResponse).length;
            const responseRate = total > 0 ? ((withResponse / total) * 100).toFixed(2) : 0;

            document.getElementById('stats-total').textContent = total;
            document.getElementById('stats-with-response').textContent = withResponse;
            document.getElementById('stats-response-rate').textContent = `${responseRate}%`;
        }

        // Otwieranie wątku
        window.openThread = async function(conversationId, apiKeyAlias, accountId) {
            const threadDiv = document.getElementById('thread-preview');
            const contentDiv = document.getElementById('thread-content');
            
            threadDiv.style.display = 'block';
            contentDiv.innerHTML = 'Ładowanie...';

            try {
                // Znajdź konwersację w cache lub pobierz ponownie
                let conversation = state.conversations.find(c => c.id === conversationId);
                
                if (!conversation?.fullData) {
                    const chatroom = await apiCall(
                        `/api/public/inbox/GetChatroom/${accountId}/${conversationId}`, 
                        'GET', 
                        null, 
                        apiKeyAlias
                    );
                    conversation.fullData = chatroom;
                }

                const data = conversation.fullData;
                
                // Wyświetl informacje o rozmówcy
                let html = `
                    <h4>Rozmówca: ${data.correspondentProfile?.firstName} ${data.correspondentProfile?.lastName}</h4>
                    <p>Firma: ${data.correspondentProfile?.companyName || 'Brak'}</p>
                    <p>Stanowisko: ${data.correspondentProfile?.position || 'Brak'}</p>
                    <p>Lokalizacja: ${data.correspondentProfile?.location || 'Brak'}</p>
                    <hr>
                    <h4>Historia wiadomości:</h4>
                `;

                // Wyświetl wiadomości
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const sender = msg.sender === 'linkedInAccount' ? 
                            `${data.linkedInAccount.firstName} ${data.linkedInAccount.lastName} (Ty)` : 
                            `${data.correspondentProfile?.firstName} ${data.correspondentProfile?.lastName}`;
                        
                        html += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                                <strong>${sender}</strong> - ${new Date(msg.createdAt).toLocaleString()}<br>
                                ${msg.subject ? `<em>Temat: ${msg.subject}</em><br>` : ''}
                                ${msg.body}
                            </div>
                        `;
                    });
                } else {
                    html += '<p>Brak wiadomości w tym wątku.</p>';
                }

                contentDiv.innerHTML = html;

            } catch (error) {
                contentDiv.innerHTML = `<p style="color:red;">Błąd ładowania wątku: ${error.message}</p>`;
            }
        };

        // Eksport do CSV
        function exportToCSV() {
            const csvRows = [];
            
            // Nagłówki
            csvRows.push([
                'conversationId',
                'campaignId',
                'campaignName',
                'senderAccountId',
                'senderFirstName',
                'senderLastName',
                'correspondentProfileUrl',
                'correspondentFirstName',
                'correspondentLastName',
                'correspondentHeadline',
                'correspondentLocation',
                'correspondentCompanyName',
                'correspondentPosition',
                'hasResponse',
                'lastMessageText',
                'lastMessageAt',
                'apiKeyAlias'
            ].join(','));

            // Dane
            state.filteredConversations.forEach(conv => {
                const campaign = state.campaigns.find(c => c.id === conv.campaignId);
                const sender = state.accounts.find(a => a.id === conv.linkedInAccountId);
                
                const row = [
                    conv.id,
                    conv.campaignId || '',
                    campaign?.name || '',
                    conv.linkedInAccountId || '',
                    sender?.firstName || '',
                    sender?.lastName || '',
                    conv.correspondentProfile?.profileUrl || '',
                    conv.correspondentProfile?.firstName || '',
                    conv.correspondentProfile?.lastName || '',
                    conv.correspondentProfile?.headline || '',
                    conv.correspondentProfile?.location || '',
                    conv.correspondentProfile?.companyName || '',
                    conv.correspondentProfile?.position || '',
                    conv.hasResponse ? 'TAK' : 'NIE',
                    `"${(conv.lastMessageText || '').replace(/"/g, '""')}"`,
                    conv.lastMessageAt || '',
                    conv.apiKeyAlias || ''
                ];
                
                csvRows.push(row.join(','));
            });

            // Pobierz plik
            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `heyreach_conversations_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Pomocnicze funkcje UI
        function showSections() {
            document.getElementById('filters-section').style.display = 'block';
            document.getElementById('stats-section').style.display = 'block';
            document.getElementById('conversations-section').style.display = 'block';
        }

        // Event listeners
        document.getElementById('fetch-data-btn').addEventListener('click', async () => {
            // Pobierz wartości konfiguracji
            state.authPassword = document.getElementById('auth-password').value;
            state.selectedApiKeys = [...document.querySelectorAll('#api-keys input:checked')].map(cb => cb.value);

            if (!state.authPassword || state.selectedApiKeys.length === 0) {
                document.getElementById('error-msg').textContent = 'Wypełnij wszystkie pola i wybierz co najmniej jeden klucz API';
                return;
            }

            await fetchData();
        });

        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

        document.getElementById('close-thread').addEventListener('click', () => {
            document.getElementById('thread-preview').style.display = 'none';
        });

        // Automatyczne stosowanie filtrów przy zmianie checkboxa "Pokaż tylko z odpowiedzią"
        document.getElementById('filter-has-response').addEventListener('change', applyFilters);
    </script>
</body>
</html>
